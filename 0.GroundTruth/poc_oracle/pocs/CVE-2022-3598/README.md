# Heap Buffer Overflow in tiffcrop

## POC URL
https://gitlab.com/libtiff/libtiff/-/issues/435

## Compilation Environment
- Linux 4a409ce47130 5.4.0-70-generic #78~18.04.1-Ubuntu SMP
- x86_64 architecture
- LIBTIFF, Version 4.4.0, commit id 8e9ce052

## Run Command
```
CFLAGS="-g -fsanitize=address -fno-omit-frame-pointer" CXXFLAGS="-g -fsanitize=address -fno-omit-frame-pointer" ./configure --prefix=$PWD/build_asan --disable-shared
make -j; make install; make clean
./build_asan/bin/tiffcrop -Z 1:4,3:3 poc /tmp/foo
```

## Expected Output
```
=================================================================
==2223766==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60c0000000b8 at pc 0x55555558ffc2 bp 0x7fffffff86c0 sp 0x7fffffff86b0
READ of size 1 at 0x60c0000000b8 thread T0
    #0 0x55555558ffc1 in extractContigSamplesShifted32bits /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:3604
    #1 0x5555555a479e in extractCompositeRegions /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:6636
    #2 0x5555555a85b7 in processCropSelections /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:7623
    #3 0x55555558b6bc in main /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:2415
    #4 0x7ffff6d87082 in __libc_start_main ../csu/libc-start.c:308
    #5 0x55555558260d in _start (/home/data/wdw/latest_programs/libtiff/build_asan/bin/tiffcrop+0x2e60d)

0x60c0000000b8 is located 0 bytes to the right of 120-byte region [0x60c000000040,0x60c0000000b8)
allocated by thread T0 here:
    #0 0x7ffff768e808 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:144
    #1 0x5555556233e5 in _TIFFmalloc /home/data/wdw/latest_programs/libtiff/libtiff/tif_unix.c:314
    #2 0x5555555827a0 in limitMalloc /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:634
    #3 0x5555555ad3e9 in rotateImage /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:8627
    #4 0x5555555a3d9c in correct_orientation /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:6495
    #5 0x55555558b5e7 in main /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:2403
    #6 0x7ffff6d87082 in __libc_start_main ../csu/libc-start.c:308

SUMMARY: AddressSanitizer: heap-buffer-overflow /home/data/wdw/latest_programs/libtiff/tools/tiffcrop.c:3604 in extractContigSamplesShifted32bits
==2223766==ABORTING
```