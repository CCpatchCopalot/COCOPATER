{
    "0": "+    uchar *end= mysql->net.read_pos+length;\n\n",
    "1": "-    if (pos < mysql->net.read_pos+length) {\n\n+    if (pos > end) {\n+        goto corrupted;\n+    }\n+    if (pos < end) {\n\n-                if (pos < mysql->net.read_pos + length) {\n\n+                if (pos < end) {\n\n-                    size_t item_len= net_field_length(&pos);\n\n+                    item_len= net_field_length(&pos);\n+                    if (pos + item_len > end) {\n+                        goto corrupted;\n+                    }\n+                    end= pos + item_len;\n\n-                    while (item_len > 0) {\n\n+                    while (pos < end) {\n\n-                                ma_clear_session_state(mysql);\n-                                SET_CLIENT_ERROR(mysql, CR__OF_MEMORY, SQLSTATE_UNKNOWN, 0);\n-                                return -1;\n\n+                                goto oom;\n\n-                                    ma_clear_session_state(mysql);\n-                                    SET_CLIENT_ERROR(mysql, CR__OF_MEMORY, SQLSTATE_UNKNOWN, 0);\n-                                    return -1;\n\n+                                    goto oom;\n\n-                                if (set_charset && strncmp(mysql->charset->csname, str->str, str->length) != 0) {\n-                                    char cs_name[64];\n-                                    MARIADB_CHARSET_FO *cs_info;\n\n+                                if (set_charset && str->length < CHARSET_NAME_LEN && strncmp(mysql->charset->csname, str->str, str->length) != 0) {\n+                                    char cs_name[CHARSET_NAME_LEN];\n+                                    const MARIADB_CHARSET_FO *cs_info;\n\n-    uchar *end= mysql->net.read_pos+length;\n\n-    if (pos > end) {\n-        goto corrupted;\n-    }\n-    if (pos < end) {\n\n+    if (pos < mysql->net.read_pos+length) {\n\n-        if (pos + item_len > end) {\n-            goto corrupted;\n-        }\n\n-                if (pos < end) {\n\n+                if (pos < mysql->net.read_pos + length) {\n\n-                    item_len= net_field_length(&pos);\n-                    if (pos + item_len > end) {\n-                        goto corrupted;\n-                    }\n-                    end= pos + item_len;\n\n+                    size_t item_len= net_field_length(&pos);\n\n-                    while (pos < end) {\n\n+                    while (item_len > 0) {\n\n+                        old_pos= pos;\n\n-                            if (pos + plen > end) {\n-                                goto corrupted;\n-                            }\n\n-                                goto oom;\n\n+                                ma_clear_session_state(mysql);\n+                                SET_CLIENT_ERROR(mysql, CR__OF_MEMORY, SQLSTATE_UNKNOWN, 0);\n+                                return -1;\n\n-                                if (pos + plen > end) {\n-                                    goto corrupted;\n-                                }\n\n-                                    goto oom;\n\n+                                    ma_clear_session_state(mysql);\n+                                    SET_CLIENT_ERROR(mysql, CR__OF_MEMORY, SQLSTATE_UNKNOWN, 0);\n+                                    return -1;\n\n-                                if (set_charset && str->length < CHARSET_NAME_LEN && strncmp(mysql->charset->csname, str->str, str->length) != 0) {\n-                                    char cs_name[CHARSET_NAME_LEN];\n-                                    const MARIADB_CHARSET_FO *cs_info;\n\n+                                if (set_charset && strncmp(mysql->charset->csname, str->str, str->length) != 0) {\n+                                    char cs_name[64];\n+                                    MARIADB_CHARSET_FO *cs_info;\n\n-                                    if ((cs_info = mysql_find_charset_name(cs_name))) {\n\n+                                    if ((cs_info = (MARIADB_CHARSET_FO *)mysql_find_charset_name(cs_name))) {\n\n-                            if (pos + plen > end) {\n-                                goto corrupted;\n-                            }\n\n+                        item_len-= (pos - old_pos);\n\n-oom:\n-    ma_clear_session_state(mysql);\n-    SET_CLIENT_ERROR(mysql, CR__OF_MEMORY, SQLSTATE_UNKNOWN, 0);\n-    return -1;\n-corrupted:\n-    ma_clear_session_state(mysql);\n-    SET_CLIENT_ERROR(mysql, CR_MALFORMED_PACKET, SQLSTATE_UNKNOWN, 0);\n-    return -1;\n\n",
    "2": "+        if (pos + item_len > end) {\n+            goto corrupted;\n+        }\n\n",
    "3": "-                        old_pos= pos;\n\n",
    "4": "+                            if (pos + plen > end) {\n+                                goto corrupted;\n+                            }\n\n",
    "5": "+                                if (pos + plen > end) {\n+                                    goto corrupted;\n+                                }\n\n",
    "6": "-                                    if ((cs_info = (MARIADB_CHARSET_FO *)mysql_find_charset_name(cs_name))) {\n\n+                                    if ((cs_info = mysql_find_charset_name(cs_name))) {\n\n",
    "7": "+                            if (pos + plen > end) {\n+                                goto corrupted;\n+                            }\n\n",
    "8": "-                        item_len-= (pos - old_pos);\n\n",
    "9": "+oom:\n+    ma_clear_session_state(mysql);\n+    SET_CLIENT_ERROR(mysql, CR__OF_MEMORY, SQLSTATE_UNKNOWN, 0);\n+    return -1;\n+corrupted:\n+    ma_clear_session_state(mysql);\n+    SET_CLIENT_ERROR(mysql, CR_MALFORMED_PACKET, SQLSTATE_UNKNOWN, 0);\n+    return -1;\n\n"
}