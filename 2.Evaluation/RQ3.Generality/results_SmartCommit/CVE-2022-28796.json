{
    "0": "-    transaction_t *commit_transaction = journal->j_running_transaction;\n-    if (!commit_transaction) {\n-        return;\n-    }\n-    spin_lock(&commit_transaction->t_handle_lock);\n-    while (atomic_read(&commit_transaction->t_updates)) {\n\n+    while (1) {\n+        transaction_t *transaction = journal->j_running_transaction;\n+        if (!transaction) {\n+            break;\n+        }\n+        spin_lock(&transaction->t_handle_lock);\n\n-        if (atomic_read(&commit_transaction->t_updates)) {\n-            spin_unlock(&commit_transaction->t_handle_lock);\n\n+        if (!atomic_read(&transaction->t_updates)) {\n+            spin_unlock(&transaction->t_handle_lock);\n+            finish_wait(&journal->j_wait_updates, &wait);\n+            break;\n+        }\n+        spin_unlock(&transaction->t_handle_lock);\n\n-            write_lock(&journal->j_state_lock);\n-            spin_lock(&commit_transaction->t_handle_lock);\n-        }\n\n-    spin_unlock(&commit_transaction->t_handle_lock);\n\n-    DEFE_WAIT(wait);\n-    while (1) {\n-        transaction_t *transaction = journal->j_running_transaction;\n-        if (!transaction) {\n-            break;\n\n+    transaction_t *commit_transaction = journal->j_running_transaction;\n+    if (!commit_transaction) {\n+        return;\n\n-        spin_lock(&transaction->t_handle_lock);\n\n+    spin_lock(&commit_transaction->t_handle_lock);\n+    while (atomic_read(&commit_transaction->t_updates)) {\n+        DEFE_WAIT(wait);\n\n-        if (!atomic_read(&transaction->t_updates)) {\n-            spin_unlock(&transaction->t_handle_lock);\n-            finish_wait(&journal->j_wait_updates, &wait);\n-            break;\n-        }\n-        spin_unlock(&transaction->t_handle_lock);\n\n+        if (atomic_read(&commit_transaction->t_updates)) {\n+            spin_unlock(&commit_transaction->t_handle_lock);\n\n+            spin_lock(&commit_transaction->t_handle_lock);\n\n+        finish_wait(&journal->j_wait_updates, &wait);\n+    }\n+    spin_unlock(&commit_transaction->t_handle_lock);\n\n",
    "1": "+        write_lock(&journal->j_state_lock);\n\n",
    "2": "-        finish_wait(&journal->j_wait_updates, &wait);\n\n",
    "3": "-    DEFE_WAIT(wait);\n\n",
    "4": "+    DEFE_WAIT(wait);\n\n"
}